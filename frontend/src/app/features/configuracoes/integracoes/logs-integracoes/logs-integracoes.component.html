<div class="logs-integracoes-container">
  <div class="header">
    <h2><i class="fas fa-list-alt"></i> Logs de Integrações</h2>
    <div class="header-actions">
      <button type="button" class="btn btn-outline-success" (click)="exportarLogs()" [disabled]="logs.length === 0">
        <i class="fas fa-download"></i> Exportar CSV
      </button>
      <button type="button" class="btn btn-primary" (click)="loadLogs()">
        <i class="fas fa-sync-alt"></i> Atualizar
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-header">
      <h5><i class="fas fa-filter"></i> Filtros</h5>
    </div>
    <div class="card-body">
      <form [formGroup]="filtrosForm">
        <div class="row">
          <div class="col-md-3">
            <div class="form-group">
              <label for="integracao_id">Integração</label>
              <select 
                id="integracao_id"
                class="form-control"
                formControlName="integracao_id"
                (change)="onFiltroChange()">
                <option value="">Todas as Integrações</option>
                <option *ngFor="let integracao of integracoes" [value]="integracao.id">
                  {{ integracao.nome }}
                </option>
              </select>
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label for="status">Status</label>
              <select 
                id="status"
                class="form-control"
                formControlName="status"
                (change)="onFiltroChange()">
                <option *ngFor="let status of statusOptions" [value]="status.value">
                  {{ status.label }}
                </option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="data_inicio">Data Início</label>
              <input 
                type="datetime-local" 
                id="data_inicio"
                class="form-control"
                formControlName="data_inicio"
                (change)="onFiltroChange()">
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="data_fim">Data Fim</label>
              <input 
                type="datetime-local" 
                id="data_fim"
                class="form-control"
                formControlName="data_fim"
                (change)="onFiltroChange()">
            </div>
          </div>
          <div class="col-md-1">
            <div class="form-group">
              <label>&nbsp;</label>
              <button 
                type="button" 
                class="btn btn-outline-secondary btn-block"
                (click)="limparFiltros()"
                title="Limpar Filtros">
                <i class="fas fa-eraser"></i>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="alert alert-danger alert-dismissible">
    {{ error }}
    <button type="button" class="close" (click)="error = null">
      <span>&times;</span>
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center">
    <div class="spinner-border" role="status">
      <span class="sr-only">Carregando...</span>
    </div>
  </div>

  <!-- Resumo -->
  <div class="row mb-3" *ngIf="!loading">
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-center">
        <span class="text-muted">
          Mostrando {{ logs.length }} de {{ totalItems }} registros
        </span>
        <span class="text-muted">
          Página {{ currentPage }} de {{ totalPages }}
        </span>
      </div>
    </div>
  </div>

  <!-- Tabela de Logs -->
  <div class="card" *ngIf="!loading">
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0">
        <thead class="thead-dark">
          <tr>
            <th>Data/Hora</th>
            <th>Integração</th>
            <th>Status</th>
            <th>Mensagem</th>
            <th>Tempo</th>
            <th>Processados</th>
            <th>Importados</th>
            <th>Atualizados</th>
            <th>Erros</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let log of logs">
            <td>
              <small>{{ formatDate(log.data_execucao) }}</small>
            </td>
            <td>
              <strong>{{ getIntegracaoNome(log.integracao_id) }}</strong>
            </td>
            <td>
              <span class="badge" [ngClass]="getStatusClass(log.status)">
                {{ getStatusLabel(log.status) }}
              </span>
            </td>
            <td>
              <span class="text-truncate d-inline-block" style="max-width: 200px;" [title]="log.mensagem">
                {{ log.mensagem || '-' }}
              </span>
            </td>
            <td>
              <small>{{ formatDuration(log.tempo_execucao) }}</small>
            </td>
            <td class="text-center">
              <span class="badge badge-info">{{ log.registros_processados }}</span>
            </td>
            <td class="text-center">
              <span class="badge badge-success">{{ log.registros_importados }}</span>
            </td>
            <td class="text-center">
              <span class="badge badge-warning">{{ log.registros_atualizados }}</span>
            </td>
            <td class="text-center">
              <span class="badge badge-danger" *ngIf="log.registros_erro > 0">{{ log.registros_erro }}</span>
              <span class="text-muted" *ngIf="log.registros_erro === 0">-</span>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <button 
                  type="button" 
                  class="btn btn-outline-info"
                  (click)="verDetalhes(log)"
                  title="Ver Detalhes">
                  <i class="fas fa-eye"></i>
                </button>
                <button 
                  type="button" 
                  class="btn btn-outline-primary"
                  (click)="executarIntegracao(log.integracao_id)"
                  [disabled]="loading"
                  title="Executar Novamente">
                  <i class="fas fa-play"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="logs.length === 0">
            <td colspan="10" class="text-center text-muted py-4">
              <i class="fas fa-inbox fa-2x mb-2"></i>
              <br>
              Nenhum log encontrado
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Paginação -->
  <nav aria-label="Navegação de páginas" *ngIf="totalPages > 1 && !loading">
    <ul class="pagination justify-content-center mt-4">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="onPageChange(1)" [class.disabled]="currentPage === 1">
          <i class="fas fa-angle-double-left"></i>
        </a>
      </li>
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="onPageChange(currentPage - 1)" [class.disabled]="currentPage === 1">
          <i class="fas fa-angle-left"></i>
        </a>
      </li>
      
      <li class="page-item" *ngFor="let page of getPages()" [class.active]="page === currentPage">
        <a class="page-link" (click)="onPageChange(page)">{{ page }}</a>
      </li>
      
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <a class="page-link" (click)="onPageChange(currentPage + 1)" [class.disabled]="currentPage === totalPages">
          <i class="fas fa-angle-right"></i>
        </a>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <a class="page-link" (click)="onPageChange(totalPages)" [class.disabled]="currentPage === totalPages">
          <i class="fas fa-angle-double-right"></i>
        </a>
      </li>
    </ul>
  </nav>

  <!-- Estatísticas Rápidas -->
  <div class="row mt-4" *ngIf="logs.length > 0 && !loading">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5><i class="fas fa-chart-bar"></i> Estatísticas da Página Atual</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <div class="text-center">
                <h4 class="text-success">{{ getStatusCount('SUCCESS') }}</h4>
                <small class="text-muted">Sucessos</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <h4 class="text-danger">{{ getStatusCount('ERROR') }}</h4>
                <small class="text-muted">Erros</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <h4 class="text-warning">{{ getStatusCount('WARNING') }}</h4>
                <small class="text-muted">Avisos</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <h4 class="text-info">{{ getStatusCount('RUNNING') }}</h4>
                <small class="text-muted">Executando</small>
              </div>
            </div>
          </div>
          <hr>
          <div class="row">
            <div class="col-md-3">
              <div class="text-center">
                <h5 class="text-primary">{{ getTotalProcessados() }}</h5>
                <small class="text-muted">Total Processados</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <h5 class="text-success">{{ getTotalImportados() }}</h5>
                <small class="text-muted">Total Importados</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <h5 class="text-warning">{{ getTotalAtualizados() }}</h5>
                <small class="text-muted">Total Atualizados</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <h5 class="text-danger">{{ getTotalErros() }}</h5>
                <small class="text-muted">Total Erros</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dicas -->
  <div class="card mt-4">
    <div class="card-header">
      <h5><i class="fas fa-lightbulb"></i> Dicas</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <h6><i class="fas fa-filter text-primary"></i> Filtros</h6>
          <p class="small">
            Use os filtros para encontrar logs específicos. Você pode filtrar por integração, status e período.
          </p>
        </div>
        <div class="col-md-4">
          <h6><i class="fas fa-download text-success"></i> Exportação</h6>
          <p class="small">
            Exporte os logs para CSV para análise externa ou relatórios.
          </p>
        </div>
        <div class="col-md-4">
          <h6><i class="fas fa-play text-warning"></i> Re-execução</h6>
          <p class="small">
            Clique no botão de play para executar novamente uma integração específica.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
